<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HospiSuite Doctor Registration</title>
    <!-- Preconnect to CDNs -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://unpkg.com">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />

    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div class="container form-container">
        <!-- Banner Section -->
        <div class="row mb-4">
            <div class="col-12">
                <img src="./docReg.webp" alt="HospiSuite Doctor Registration Banner" class="img-fluid banner-image" style="width: 100%; height: auto;">
            </div>
        </div>
        <!-- Form Section -->
        <form>
            <div class="form-section" data-aos="fade-down">
                <label for="email" class="form-label">Email </label><b style="color: red;"> *</b><br>
                <label for="description"><small>You'll receive important updates and notifications at this email</small></label>
                <input type="email" class="form-control" id="email" placeholder="Enter your email" required>
            </div>

            <div class="form-section" data-aos="fade-down">
                <label for="fullName" class="form-label">Full Name </label><b style="color: red;"> *</b><br>
                <label for="description"><small>As per your official records</small></label>
                <input type="text" class="form-control" id="fullName" placeholder="Enter fullname" required>
            </div>

            <div class="form-section" data-aos="fade-down">
                <label class="form-label">Gender </label><b style="color: red;"> *</b>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male" required>
                    <label class="form-check-label" for="genderMale">Male</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female">
                    <label class="form-check-label" for="genderFemale">Female</label>
                </div>
            </div>

            <div class="form-section" data-aos="fade-up">
                <label for="mobile" class="form-label">Mobile Number</label><b style="color: red;"> *</b><br>
                <label for="description"><small>You will receive online consultation links via this number (preferably WhatsApp)</small></label>
                <input type="tel" class="form-control" id="mobile" placeholder="Phone Number" required>
            </div>

            <button type="submit" class="submit btn btn-black w-100">Submit</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
        AOS.init({
            disable: false,
            startEvent: 'DOMContentLoaded',
            initClassName: 'aos-init',
            animatedClassName: 'aos-animate',
            useClassNames: false,
            disableMutationObserver: false,
            debounceDelay: 50,
            throttleDelay: 99,
            offset: 80,
            delay: 0,
            duration: 600,
            easing: 'ease',
            once: false,
            mirror: true,
            anchorPlacement: 'top-bottom'
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Function to validate a field and update the parent form-section
            function validateField(field) {
                const formSection = field.closest('.form-section');
                let isValid = false;

                if (field.tagName === 'INPUT') {
                    if (field.type === 'email') {
                        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        isValid = emailPattern.test(field.value);
                    } else if (field.type === 'tel') {
                        const phonePattern = /^\d{10,}$/;
                        isValid = phonePattern.test(field.value);
                    } else {
                        isValid = field.value.trim() !== '';
                    }
                }

                if (isValid) {
                    formSection.classList.add('form-section-valid');
                } else {
                    formSection.classList.remove('form-section-valid');
                }
            }

            // Special validation for radio buttons (Gender)
            function validateRadioButtons(name) {
                const radios = document.querySelectorAll(`input[name="${name}"]`);
                const formSection = radios[0].closest('.form-section');
                const isChecked = Array.from(radios).some(radio => radio.checked);

                if (isChecked) {
                    formSection.classList.add('form-section-valid');
                } else {
                    formSection.classList.remove('form-section-valid');
                }
            }

            // Add event listeners to all inputs
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    input.addEventListener('change', () => validateRadioButtons(input.name));
                } else {
                    input.addEventListener('input', () => validateField(input));
                    input.addEventListener('change', () => validateField(input));
                    input.addEventListener('blur', () => validateField(input));
                }
            });

            // Form submission and encryption logic
            document.querySelector('form').addEventListener('submit', async (e) => {
                e.preventDefault();
                let query = window.location.search.substring(1);
                let userNumber = query.replace(/^q=/, "");
                console.log(userNumber);

                const formData = {
                    email: document.getElementById('email').value,
                    fullName: document.getElementById('fullName').value,
                    gender: document.querySelector('input[name="gender"]:checked')?.value || '',
                    mobile: document.getElementById('mobile').value,
                    waNumber: userNumber
                };

                console.log('Form Data:', formData);

                try {
                    const data = JSON.stringify(formData);
                    const encoder = new TextEncoder();
                    const key = await crypto.subtle.generateKey(
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    );
                    console.log('Generated Key:', key);

                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const encryptData = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        key,
                        encoder.encode(data)
                    );

                    const exported = await crypto.subtle.exportKey('jwk', key);
                    console.log('Exported Key:', exported);

                    const encryptedArray = new Uint8Array(encryptData);
                    const cipherText = encryptedArray.slice(0, -16);
                    const tag = encryptedArray.slice(-16);

                    const payload = {
                        encryptData: arrayBufferToBase64(cipherText),
                        tag: arrayBufferToBase64(tag),
                        iv: arrayBufferToBase64(iv),
                        exportedKey: JSON.stringify(exported)
                    };
                    console.log('\n\nPayload generated:', payload);

                    fetch('https://d2u4fyx6ods8mm.cloudfront.net/registration/auth/', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        }
                    })
                        .then(response => response.json())
                        .then(token => {
                            console.log('Auth Token Received:', token);
                            console.log('Sending data to server');
                            fetch('https://d2u4fyx6ods8mm.cloudfront.net/registration/submit/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json',
                                    'Authorization': token,
                                },
                                body: JSON.stringify({
                                    data: payload,
                                }),
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('Success:', data);
                                    console.log('Message:', data.msg);
                                    console.log('Status:', data.status);
                                    if (data.msg === "Duplicate Data") {
                                        alert('You have already registered with this email id');
                                        document.querySelector('form').reset();
                                        setTimeout(() => {
                                            let link = document.createElement("a");
                                            link.href = "https://wa.me/918415082512";
                                            link.target = "_blank";
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        }, 1000);
                                        return;
                                    } else if (data.msg === "Form submitted successfully") {
                                        alert('Register Success!!\nThank you for registering with Hospisuite.\n\nRedirecting to Hospisuite WhatsApp Bot');
                                        document.querySelector('form').reset();
                                        setTimeout(() => {
                                            let link = document.createElement("a");
                                            link.href = "https://wa.me/918415082512";
                                            link.target = "_blank";
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        }, 1000);
                                    } else {
                                        alert('Form submission failed. Please try again.');
                                        document.querySelector('form').reset();
                                        setTimeout(() => {
                                            let link = document.createElement("a");
                                            link.href = "https://wa.me/918415082512";
                                            link.target = "_blank";
                                            document.body.appendChild(link);
                                            link.click();
                                            document.body.removeChild(link);
                                        }, 1000);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error sending data:', error);
                                });
                        })
                        .catch(error => {
                            console.error('Error fetching token:', error);
                        });
                } catch (error) {
                    console.error('Encryption error:', error);
                }
            });

            function arrayBufferToBase64(buffer) {
                return btoa(String.fromCharCode(...new Uint8Array(buffer)));
            }
        });
    </script>
</body>
</html>